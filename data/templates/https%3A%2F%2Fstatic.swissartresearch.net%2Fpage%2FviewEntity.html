[[> partial:pageHeader]]

[[#*inline "thisIri"]][[#if entityiri]][[entityiri]][[else]][[urlParam "entityiri"]][[/if]][[/inline]]

[[#*inline "thisForQuery"]]
    <[[> thisIri]]>
[[/inline]]

<div class="d-flex flex-md-row flex-column">
    <div class="bso-component separator sidebar image-display">
        <semantic-if 
            query='ASK { [[> thisForQuery ]] a search:Object}'
            then='{{> objectTemplate }}'
            else='{{> template}}'
        >
            <template id="objectTemplate">
                [[#if entityiri]]
                    [[> partial:objectViewImageDisplay objectiri=entityiri]]
                [[else]]
                    [[> partial:objectViewImageDisplay urlparam="entityiri"]]
                [[/if]]
            </template>
            <template id="template">
                <bs-panel>
                    <mp-resource-thumbnail iri="[[> thisIri]]">
                        <mp-resource-thumbnail-fallback>
                            <span></span>
                        </mp-resource-thumbnail-fallback>
                    </mp-resource-thumbnail>
                </bs-panel>
            </template>
        </semantic-if>
    </div>
    <div class="bso-component main">
        <div class="bso-component panel">
            <h2><mp-label iri="[[> thisIri]]"></mp-label></h2>

            <!-- Depicts -->
            <semantic-query
                query="SELECT DISTINCT ?subject ?type ?typeClass WHERE {
                    [[> thisForQuery]] crm:P128_carries/crm:P138_represents ?subject .
                    ?subject a ?type .
                    BIND(STRAFTER(STR(?type), 'search/') as ?typeClass)
                    VALUES(?type) {
                        (search:Person)
                        (search:Place)
                        (search:Type)
                    }
                }"
                template="{{> template}}">
                <template id="template">
                    <div class="bso-component field-visualisation">
                        <span class="bso-component label">[[i18n "depicts" bundle="bso"]]</span>
                        <ul class="bso-component tags">
                            {{#each bindings}}
                                <li class="bso-tag {{typeClass.value}}"><semantic-link uri="{{subject.value}}"></semantic-link></li>
                            {{/each}}
                        </ul>
                    </div>
                </template>
            </semantic-query>

            <!-- Same as / External Links -->
            <semantic-query
                query="SELECT DISTINCT ?subject WHERE {
                    [[> thisForQuery]] crmdig:L54_is_same-as ?subject .
                }"
                template="{{> template}}">
                <template id="template">
                    <div class="bso-component field-visualisation">
                        <span class="bso-component label">[[i18n "externalLinks" bundle="bso"]]</span>
                        <ul class="bso-component tags">
                            {{#each bindings}}
                                <li class="bso-tag"><a href="{{subject.value}}" target="_blank"><mp-label iri="{{subject.value}}"></mp-label></a></li>
                            {{/each}}
                        </ul>
                    </div>
                </template>
            </semantic-query>

            <!-- Dates -->
            <semantic-query
                query="SELECT DISTINCT ?subject ?event ?eventType WHERE {
                    [[> thisForQuery]] crm:P108i_was_produced_by|(crm:P128_carries/crm:P94i_was_created_by) ?event .
                    ?event crm:P4_has_time-span ?subject .
                    ?event a ?eventType .
                }"
                template="{{> template}}">>
                <template id="template">
                    <div class="bso-component field-visualisation">
                        <span class="bso-component label">[[i18n "dates" bundle="bso"]]</span>
                        <table>
                            {{#each bindings}}
                            <tr>
                                <td><semantic-link iri="{{subject.value}}"></semantic-link></td>
                                <td><mp-label iri="{{eventType.value}}"></mp-label></td>
                            </tr>
                            {{/each}}
                        </table>
                    </div>
                </template>
            </semantic-query>

            <!-- Contained in -->
            <semantic-query
                query="SELECT DISTINCT ?subject ?type ?typeClass WHERE {
                    [[> thisForQuery]] crm:P46i_forms_part_of ?subject .
                    ?subject a ?type .
                    BIND(STRAFTER(STR(?type), 'search/') as ?typeClass)
                    VALUES(?type) {
                        (search:Object)
                    }
                }"
                template="{{> template}}">
                <template id="template">
                    <div class="bso-component field-visualisation">
                        <span class="bso-component label">[[i18n "containedIn" bundle="bso"]]</span>
                        <ul class="bso-component tags">
                            {{#each bindings}}
                                <li class="bso-tag {{typeClass.value}}"><semantic-link uri="{{subject.value}}" urlqueryparam-view="page"></semantic-link></li>
                            {{/each}}
                        </ul>
                    </div>
                </template>
            </semantic-query>

            <!-- Persons involved in creation-->
            <semantic-query
                query="SELECT DISTINCT ?subject ?role WHERE {
                    {
                        [[> thisForQuery]] crm:P108i_was_produced_by|(crm:P128_carries/crm:P94i_was_created_by) ?event .
                    } UNION 
                    {
                        [[> thisForQuery]] (crm:P128_carries/crm:P94i_was_created_by) ?event .
                    }
                    {
                        ?event crm:P14_carried_out_by ?subject .
                        OPTIONAL {
                            ?event crm:P9_consists_of ?subevent .
                            ?subevent crm:P14_carried_out_by ?subject .
                            OPTIONAL {
                                ?subevent crm:P2_has_type ?role .
                            }
                        }
                    } UNION {
                        ?event crm:P9_consists_of ?subevent .
                        ?subevent crm:P14_carried_out_by ?subject .
                        OPTIONAL {
                            ?subevent crm:P2_has_type ?role .
                        }
                    }
                }"
                template="{{> template}}">>
                <template id="template">
                    <div class="bso-component field-visualisation">
                        <span class="bso-component label">[[i18n "persons" bundle="bso"]]</span>
                        <table>
                            {{#each bindings}}
                            <tr>
                                <td>
                                    <ul class="bso-component tags">
                                            <li class="bso-tag Person"><semantic-link uri="{{subject.value}}"></semantic-link></li>
                                    </ul>
                                </td>
                                <td><mp-label iri="{{role.value}}"></mp-label></td>
                            </tr>
                            {{/each}}
                        </table>
                    </div>
                </template>
            </semantic-query>

            <!-- Objects created -->
            [[#> objectsTable condition='?object a search:Object; (crm:P108i_was_produced_by|(crm:P128_carries/crm:P94i_was_created_by))/crm:P9_consists_of?/crm:P14_carried_out_by $subject' label='works']]

                {
                    ?subject crm:P108i_was_produced_by/crm:P9_consists_of?/crm:P14_carried_out_by [[> thisForQuery]] .
                } UNION {
                    ?subject crm:P128_carries/crm:P94i_was_created_by/crm:P9_consists_of?/crm:P14_carried_out_by [[> thisForQuery]] .
                }
                
            [[/ objectsTable]]

            <!-- Objects forming part of -->
            [[#> objectsTable condition='?object a search:Object; crm:P46i_forms_part_of $subject' label='contains']]

                ?subject crm:P46i_forms_part_of [[> thisForQuery]]
                
            [[/ objectsTable]]

            <!-- Depicted -->
            [[#> objectsTable condition='?thing crm:P138_represents $subject' label='depictedBy' ]]

                ?subject crm:P128_carries/crm:P138_represents [[> thisForQuery]] .
            
            [[/ objectsTable]]

            <!-- Objects owned -->
            [[#> objectsTable condition='?object a search:Object; crm:P109_has_former_or_current_curator $subject' label='worksHeld']]
                
                ?subject crm:P109_has_former_or_current_curator [[> thisForQuery]] .
                
            [[/ objectsTable]]
        </div>

        [[#if (hasPermission "api:ldp:*")]]
        <semantic-if query="ASK { [[> thisForQuery]] a search:Object .}" then="{{> template}}">
            <template id="template">
                <div class="bso-component separator panel">
                    <h3>[[i18n "customData" bundle="bso"]]</h3>
                    <semantic-table
                        query="SELECT ?proposition ?subject ?type ?container ?dateCreated ?parentContainer ?page ?form (GROUP_CONCAT(?entity;SEPARATOR=',') as ?entities) WHERE {
                            ?proposition a crminf:I4_Proposition_Set ;
                                crm:P67_refers_to [[> thisForQuery]] ;
                                crm:P129_is_about ?subject .
                            ?subject a ?type .
                            BIND(URI(STRBEFORE(STR(?proposition), '/context')) as ?container)
                            ?parentContainer ldp:contains ?container .
                            ?container prov:used ?page_and_form ;
                                prov:generatedAtTime ?dateCreated .
                            BIND(STRBEFORE(STR(?page_and_form), '#') as ?page)
                            BIND(STRAFTER(STR(?page_and_form), '#') as ?form)
                            OPTIONAL {
                                ?subject crm:P14_carried_out_by ?entity .
                            } 
                            OPTIONAL {
                                ?subject crm:P141_assigned ?entity .
                            } 
                        } GROUP BY ?proposition ?subject ?type ?container ?dateCreated ?parentContainer ?page ?form
                        ORDER BY ?dateCreated"
                        column-configuration='[{
                            "displayName": "[[i18n "type" bundle="bso"]]",
                            "cellTemplate": "<mp-label iri=\"{{type.value}}\"></mp-label>"
                        },
                        {
                            "displayName": "[[i18n "entities" bundle="bso"]]",
                            "cellTemplate": "{{> entityTemplate}}"
                        },
                        {
                            "displayName": "[[i18n "created" bundle="bso"]]",
                            "cellTemplate": "{{dateTimeFormat dateCreated.value \"DD.MM.YYYY H:mm\"}}"
                        },
                        {
                            "displayName": "[[i18n "actions" bundle="bso"]]",
                            "cellTemplate": "{{> actionTemplate }}"
                        }]'
                    >
                        <template id="actionTemplate">
                            <div class="bso-component button-set">
                                <button class="btn btn-secondary btn-xs">
                                    <semantic-link iri="http://www.metaphacts.com/resource/assets/NamedGraph" 
                                        urlqueryparam-view="graph" 
                                        urlqueryparam-graph="{{proposition.value}}">
                                        [[i18n "view" bundle="bso"]]
                                    </semantic-link>
                                </button>
                                <button class="btn btn-secondary btn-xs">
                                    <semantic-link iri="{{ page.value }}"
                                        urlqueryparam-subjectiri="{{subject.value}}"
                                        urlqueryparam-objectiri="[[>thisIri]]"
                                        urlqueryparam-form="{{ form.value }}"
                                    >[[i18n "edit" bundle="bso"]]</semantic-link>
                                </button>
                                <button class="btn btn-secondary btn-xs">
                                    <semantic-link iri="page:deleteContainerFromParent" 
                                        urlqueryparam-container="{{container.value}}" 
                                        urlqueryparam-parent="{{parentContainer.value}}" 
                                        urlqueryparam-back="[[>thisIri]]">[[i18n "delete" bundle="bso"]]
                                    </semantic-link>
                                </button>
                            </div>
                        </template>
                        <template id="entityTemplate">
                            {{#if entities.value}}
                                {{#each (split entities.value ",")}}<semantic-link iri="{{this}}"></semantic-link>{{#unless @last}}, {{/unless}}{{/each}}
                            {{/if}}
                        </template>
                    </semantic-table>
                    <semantic-link
                        iri="page:addEditDataForObject"
                    urlqueryparam-objectiri="[[> thisIri]]"
                    ><button type="button" class="btn btn-primary btn-s">[[i18n "addData" bundle="bso"]]</button></semantic-link>
                </div>
            </template>
        </semantic-if>
        [[/if]]

        <div class="bso-component separator panel">

            <h3>[[i18n "fields" bundle="bso"]]</h3>
            [[> partial:fieldsTable iri=entityiri param="entityiri" ]]

        </div>
    </div>
</div>

[[#*inline "objectsTable"]]

    <semantic-if 
        query='ASK { BIND([[> thisForQuery]] as $subject) . [[condition]] }'
        then='{{> template}}'
    >
        <template id="template">
            <div class="bso-component field-visualisation">
                <span class="bso-component label">[[i18n label bundle="bso"]]</span>
                <div class="bso-component card-container">
                    <semantic-table
                    query="SELECT DISTINCT ?subject WHERE {
                        ?subject a search:Object .
                        [[> @partial-block]]
                    }"
                    tuple-template="{{> partial:cardObject}}">
                    </semantic-table>
                </div>
            </div>
        </template>
    </semantic-if>

[[/inline]]

[[> partial:pageFooter]]